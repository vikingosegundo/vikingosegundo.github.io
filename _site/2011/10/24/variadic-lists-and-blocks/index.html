<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Manuel Meyer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">

  <link href="/stylesheets/more.css" rel="stylesheet">
  <link href="/stylesheets/syntax.css" rel="stylesheet">
</head>

<body>
  <div id="header">
    <a href="/"><div class="avatar">&nbsp;</div></a>
      <div class="personal-details">
        <a href="/"><h1>Manuel Meyer</h1></a>
        <p>
          Software Engineer
        </p>
        <ul>
          <li><a href="http://stackoverflow.com/users/106435/vikingosegundo">stackoverflow</a></li>
          <li><a href="http://github.com/vikingosegundo">github</a></li>
          <li><a href="http://twitter.com/vikingosegundo">twitter</a></li>
        </ul>
      </div>
  </div>

  <div class="container">

<div id="content">

<div class="row-fluid">
  <div class="span8">
    <h1>Variadic Lists and Blocks</h1>

    <p>Matt Gallagher <a href="http://cocoawithlove.com/2009/05/variable-argument-lists-in-cocoa.html">posted an great article about veriadic lists</a>. In his conclusion he writes</p>

<blockquote><p>In your own code, variadic methods should be used sparingly — passing variables in an NSArray or NSDictionary is safer (if slightly slower and syntactically more verbose) due to the fact that these classes do offer introspection.<br/>
And I think he is right.
But now I found a situation, where it makes much more sense to have a veridic list of arguments rather a NSArray or NSDictionary.</p></blockquote>

<p>I wrote a Category method on NSArray, that allows the user, to filter the array by blocks and create a dictionary with given keys.</p>

<pre><code class="objc">
- (NSDictionary *) dictionaryByFilteringWithBlocks:(NSArray *)filterBlocks
                                           forKeys:(NSArray *)keys
</code></pre>

<!--break-->


<p>And it is used like</p>

<pre><code class="objc">
NSArray *blocks = [NSArray arrayWithObjects:
                ^BOOL(id element) {return [element hasPrefix:@"a"];},
                ^BOOL(id element) {return [element hasPrefix:@"c"];},
                ^BOOL(id element) {return [element hasPrefix:@"z"];},
           nil];

NSArray *keys = [NSArray arrayWithObjects:@"a",@"c", @"z", nil];
NSDictionary *dict = [array dictionaryByFilteringWithBlocks:blocks forKeys:keys];
</code></pre>

<p>it works as expected, but has two flaws:</p>

<ul>
<li>the corresponding blocks and key are separated — I don't like that</li>
<li>Xcode's code completion won't help you to create your blocks, as it will just tell you that you need two arrays</li>
</ul>


<p>I think, that is reason enough to give veriadic methods a try — and here we go:</p>

<pre><code class="objc">- (NSDictionary *) dictionaryByFilteringWithBlocksAndKeys:(BOOL (^)(id element))firstBlock, id firstKey,... NS_REQUIRES_NIL_TERMINATION;

-(NSDictionary *)dictionaryByFilteringWithBlocksAndKeys:(TestBlock)firstBlock, id firstKey,...
{
    NSMutableDictionary *results = [NSMutableDictionary dictionary];
    NSMutableArray *blocks = [[NSMutableArray alloc] initWithObjects:firstBlock, nil];
    NSMutableArray *keys = [NSMutableArray arrayWithObject:firstKey];

    va_list args;
    va_start(args, firstKey);
    while (YES) {
        TestBlock block = va_arg(args, TestBlock);

        if (! block)
            break;

        [blocks addObject:Block_copy(block)];
        id key = va_arg(args, id);  
        if (!key) [NSException raise:@"wrong number of arguments" format:@"n blocks need n keys", nil];
        [keys addObject:key];
    }
    va_end(args);

    for(id key in keys){
        NSMutableArray *filtered = [NSMutableArray array] ;
        [results setObject:filtered forKey:key];
        BOOL (^block)(id) = [blocks objectAtIndex:[keys indexOfObject:key]];
        for (id element in self){
            if (block(element)){
                [filtered addObject:element];
            }
        }
    }
    for(BOOL (^block)(id) in blocks){
        Block_release(block);
    }
    [blocks release];
    return  results;
}
</code></pre>

<pre><code class="objc">NSArray *array = [NSArray arrayWithObjects:@"a", @"aa", @"ab", @"cc", @"cd", @"dd", nil];
NSDictionary *dict = [array dictionaryByFilteringWithBlocksAndKeys:
                ^BOOL(id element) {return [element hasPrefix:@"a"];},@"a",
                ^BOOL(id element) {return [element hasPrefix:@"c"];},@"c",
             nil];
NSLog(@"%@", dict);
</code></pre>

<p>result:</p>

<pre><code class="objc">
{
    a =     (
        a,
        aa,
        ab
    );
    c =     (
        cc,
        cd
    );
}
</code></pre>

  </div>
  <div class="span4">
  </div>

  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'vikingosegundo'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  
</div>
</div>
</div>
</body>
</html>

